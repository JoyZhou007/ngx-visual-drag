import { Injectable } from '@angular/core';
import { NzMessageService } from 'ng-zorro-antd/message';
import { Subject } from 'rxjs';
import generateID from '../../utils/generateID';
import { deepCopy, swap } from '../../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "ng-zorro-antd/message";
export class ComponentDataService {
    constructor(message) {
        this.message = message;
        this.componentData = []; // 画布组件数据
        this.canvasStyleData = {
            width: 1200,
            height: 740,
        }; // 页面全局数据
        this.$shapeStyle = new Subject();
        this.contextmenu = {
            show: false,
            top: 0,
            left: 0,
        }; // 右击菜单数据
        this.snapshotData = []; // 编辑器快照数据
        this.snapshotIndex = -1; // 快照索引
        this.notification = new Subject();
        this.$storageData = new Subject();
        this.initData();
        this.$shapeStyle.subscribe((x) => {
            if (x.top)
                this.curComponent.style.top = x.top;
            if (x.left)
                this.curComponent.style.left = x.left;
            if (x.width)
                this.curComponent.style.width = x.width;
            if (x.height)
                this.curComponent.style.height = x.height;
            if (x.rotate)
                this.curComponent.style.rotate = x.rotate;
        });
    }
    initData() { }
    deleteCurComponent() {
        this.componentData.splice(this.curComponentIndex, 1);
    }
    hideContextMenu() {
        this.contextmenu = {
            show: false,
            top: 0,
            left: 0,
        };
    }
    upComponent() {
        // 上移图层 index，表示元素在数组中越往后
        if (this.curComponentIndex < this.componentData.length - 1) {
            swap(this.componentData, this.curComponentIndex, this.curComponentIndex + 1);
        }
        else {
            this.message.warning('已经到顶了');
        }
    }
    downComponent() {
        // 下移图层 index，表示元素在数组中越往前
        if (this.curComponentIndex > 0) {
            swap(this.componentData, this.curComponentIndex, this.curComponentIndex - 1);
        }
        else {
            this.message.warning('已经到底了');
        }
    }
    topComponent() {
        // 置顶
        if (this.curComponentIndex < this.componentData.length - 1) {
            swap(this.componentData, this.curComponentIndex, this.componentData.length - 1);
        }
        else {
            this.message.warning('已经到顶了');
        }
    }
    bottomComponent() {
        // 置底
        if (this.curComponentIndex > 0) {
            swap(this.componentData, this.curComponentIndex, 0);
        }
        else {
            this.message.warning('已经到底了');
        }
    }
    recordSnapshot() {
        // 添加新的快照
        this.snapshotData[++this.snapshotIndex] = deepCopy(this.componentData);
        // 在 undo 过程中，添加新的快照时，要将它后面的快照清理掉
        if (this.snapshotIndex < this.snapshotData.length - 1) {
            this.snapshotData = this.snapshotData.slice(0, this.snapshotIndex + 1);
        }
    }
    undo() {
        if (this.snapshotIndex >= 0) {
            this.snapshotIndex--;
            this.componentData =
                deepCopy(this.snapshotData[this.snapshotIndex]) || [];
        }
    }
    redo() {
        if (this.snapshotIndex < this.snapshotData.length - 1) {
            this.snapshotIndex++;
            this.componentData =
                deepCopy(this.snapshotData[this.snapshotIndex]) || [];
        }
    }
    setShapePosStyle({ key, value }) {
        this.curComponent.style[key] = value;
    }
    copy() {
        this.copyData = {
            data: deepCopy(this.curComponent),
            index: this.curComponentIndex,
        };
    }
    paste(isMouse) {
        if (!this.copyData) {
            this.message.warning('请选择组件');
            return;
        }
        const data = this.copyData.data;
        if (isMouse) {
            data.style.top = this.contextmenu.top;
            data.style.left = this.contextmenu.left;
        }
        else {
            data.style.top += 10;
            data.style.left += 10;
        }
        data.id = generateID();
        this.addComponent(data);
        this.recordSnapshot();
        this.copyData = null;
    }
    addComponent(component, index) {
        if (index !== undefined) {
            this.componentData.splice(index, 0, component);
        }
        else {
            this.componentData.push(component);
        }
    }
    cut() {
        if (!this.curComponent) {
            this.message.warning('请选择组件');
            return;
        }
        if (this.copyData) {
            this.addComponent(this.copyData.data, this.copyData.index);
            if (this.curComponentIndex >= this.copyData.index) {
                // 如果当前组件索引大于等于插入索引，需要加一，因为当前组件往后移了一位
                this.curComponentIndex++;
            }
        }
        this.copy();
        this.deleteCurComponent();
    }
    clearCanvas() {
        this.componentData = [];
    }
    restore(data) {
        // 用保存的数据恢复画布
        if (data) {
            this.componentData = this.resetID(data.canvasData);
            this.canvasStyleData = data.canvasStyle;
        }
        else {
            if (localStorage.getItem('canvasData')) {
                this.componentData = this.resetID(JSON.parse(localStorage.getItem('canvasData')));
            }
            if (localStorage.getItem('canvasStyle')) {
                this.canvasStyleData = JSON.parse(localStorage.getItem('canvasStyle'));
            }
        }
    }
    save() {
        localStorage.setItem('canvasData', JSON.stringify(this.componentData));
        localStorage.setItem('canvasStyle', JSON.stringify(this.canvasStyleData));
        this.message.success('保存成功');
        this.$storageData.next({
            canvasData: this.componentData,
            canvasStyle: this.canvasStyleData,
        });
    }
    resetID(data) {
        data.forEach((item) => {
            item.id = generateID();
        });
        return data;
    }
    setEditMode(type) {
        this.editMode = type;
    }
}
ComponentDataService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ComponentDataService_Factory() { return new ComponentDataService(i0.ɵɵinject(i1.NzMessageService)); }, token: ComponentDataService, providedIn: "root" });
ComponentDataService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
ComponentDataService.ctorParameters = () => [
    { type: NzMessageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9uZW50LWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtdmlzdWFsLWRyYWcvc3JjLyIsInNvdXJjZXMiOlsibGliL2NvcmUvY29tcG9uZW50L2NvbXBvbmVudC1kYXRhLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBUy9CLE9BQU8sVUFBVSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hELE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7OztBQUtuRCxNQUFNLE9BQU8sb0JBQW9CO0lBMkIvQixZQUFvQixPQUF5QjtRQUF6QixZQUFPLEdBQVAsT0FBTyxDQUFrQjtRQTFCN0Msa0JBQWEsR0FBd0IsRUFBRSxDQUFDLENBQUMsU0FBUztRQUNsRCxvQkFBZSxHQUFvQjtZQUNqQyxLQUFLLEVBQUUsSUFBSTtZQUNYLE1BQU0sRUFBRSxHQUFHO1NBQ1osQ0FBQyxDQUFDLFNBQVM7UUFHWixnQkFBVyxHQUFnQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3pELGdCQUFXLEdBSVA7WUFDRixJQUFJLEVBQUUsS0FBSztZQUNYLEdBQUcsRUFBRSxDQUFDO1lBQ04sSUFBSSxFQUFFLENBQUM7U0FDUixDQUFDLENBQUMsU0FBUztRQUNaLGlCQUFZLEdBQStCLEVBQUUsQ0FBQyxDQUFDLFVBQVU7UUFDekQsa0JBQWEsR0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDbkMsaUJBQVksR0FHUCxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBR25CLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQWUsQ0FBQztRQUV4QyxJQUFJLENBQUMsUUFBUSxFQUFFLENB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Q0FBQyxDQUFDLENBQUM7YUFDeEU7U0FDRjtJQUNILENBQUM7SUFFRCxJQUFJO1FBQ0YsWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN2RSxZQUFZLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDO1lBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsYUFBYTtZQUM5QixXQUFXLEVBQUUsSUFBSSxDQUFDLGVBQWU7U0FDbEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUFJO1FBQ1YsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3BCLElBQUksQ0FBQyxFQUFFLEdBQUcsVUFBVSxFQUFFLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRCxXQUFXLENBQUMsSUFBa0I7UUFDNUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDdkIsQ0FBQzs7OztZQXBPRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWZRLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE56TWVzc2FnZVNlcnZpY2UgfSBmcm9tICduZy16b3Jyby1hbnRkL21lc3NhZ2UnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgQ2FudmFzU3R5bGVEYXRhLFxuICBDb21wb25lbnRCYXNlU3R5bGUsXG4gIENvbXBvbmVudEJhc2VEYXRhLFxuICBDb3B5RGF0YSxcbiAgRWRpdE1vZGVUeXBlLFxuICBTdG9yYWdlRGF0YSxcbn0gZnJvbSAnLi4vLi4vdHlwZXMvY29tcG9uZW50LXR5cGUnO1xuaW1wb3J0IGdlbmVyYXRlSUQgZnJvbSAnLi4vLi4vdXRpbHMvZ2VuZXJhdGVJRCc7XG5pbXBvcnQgeyBkZWVwQ29weSwgc3dhcCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWxzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIENvbXBvbmVudERhdGFTZXJ2aWNlIHtcbiAgY29tcG9uZW50RGF0YTogQ29tcG9uZW50QmFzZURhdGFbXSA9IFtdOyAvLyDnlLvluIPnu4Tku7bmlbDmja5cbiAgY2FudmFzU3R5bGVEYXRhOiBDYW52YXNTdHlsZURhdGEgPSB7XG4gICAgd2lkdGg6IDEyMDAsXG4gICAgaGVpZ2h0OiA3NDAsXG4gIH07IC8vIOmhtemdouWFqOWxgOaVsOaNrlxuICBjdXJDb21wb25lbnQ6IENvbXBvbmVudEJhc2VEYXRhO1xuICBjdXJDb21wb25lbnRJbmRleDogbnVtYmVyO1xuICAkc2hhcGVTdHlsZTogU3ViamVjdDxDb21wb25lbnRCYXNlU3R5bGU+ID0gbmV3IFN1YmplY3QoKTtcbiAgY29udGV4dG1lbnU6IHtcbiAgICBzaG93OiBib29sZWFuO1xuICAgIHRvcDogbnVtYmVyO1xuICAgIGxlZnQ6IG51bWJlcjtcbiAgfSA9IHtcbiAgICBzaG93OiBmYWxzZSxcbiAgICB0b3A6IDAsXG4gICAgbGVmdDogMCxcbiAgfTsgLy8g5Y+z5Ye76I+c5Y2V5pWw5o2uXG4gIHNuYXBzaG90RGF0YTogQXJyYXk8Q29tcG9uZW50QmFzZURhdGFbXT4gPSBbXTsgLy8g57yW6L6R5Zmo5b+r54Wn5pWw5o2uXG4gIHNuYXBzaG90SW5kZXg6IG51bWJlciA9IC0xOyAvLyDlv6vnhafntKLlvJVcbiAgbm90aWZpY2F0aW9uOiBTdWJqZWN0PHtcbiAgICBldmVudDogc3RyaW5nO1xuICAgIHZhbHVlPzogYW55O1xuICB9PiA9IG5ldyBTdWJqZWN0KCk7XG4gIGNvcHlEYXRhOiBDb3B5RGF0YTtcbiAgZWRpdE1vZGU6IEVkaXRNb2RlVHlwZTtcbiAgJHN0b3JhZ2VEYXRhID0gbmV3IFN1YmplY3Q8U3RvcmFnZURhdGE+KCk7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWVzc2FnZTogTnpNZXNzYWdlU2VydmljZSkge1xuICAgIHRoaXMuaW5pdERhdGEoKTtcbiAgICB0aGlzLiRzaGFwZVN0eWxlLnN1YnNjcmliZSgoeCkgPT4ge1xuICAgICAgaWYgKHgudG9wKSB0aGlzLmN1ckNvbXBvbmVudC5zdHlsZS50b3AgPSB4LnRvcDtcbiAgICAgIGlmICh4LmxlZnQpIHRoaXMuY3VyQ29tcG9uZW50LnN0eWxlLmxlZnQgPSB4LmxlZnQ7XG4gICAgICBpZiAoeC53aWR0aCkgdGhpcy5jdXJDb21wb25lbnQuc3R5bGUud2lkdGggPSB4LndpZHRoO1xuICAgICAgaWYgKHguaGVpZ2h0KSB0aGlzLmN1ckNvbXBvbmVudC5zdHlsZS5oZWlnaHQgPSB4LmhlaWdodDtcbiAgICAgIGlmICh4LnJvdGF0ZSkgdGhpcy5jdXJDb21wb25lbnQuc3R5bGUucm90YXRlID0geC5yb3RhdGU7XG4gICAgfSk7XG4gIH1cblxuICBpbml0RGF0YSgpIHt9XG5cbiAgZGVsZXRlQ3VyQ29tcG9uZW50KCkge1xuICAgIHRoaXMuY29tcG9uZW50RGF0YS5zcGxpY2UodGhpcy5jdXJDb21wb25lbnRJbmRleCwgMSk7XG4gIH1cblxuICBoaWRlQ29udGV4dE1lbnUoKSB7XG4gICAgdGhpcy5jb250ZXh0bWVudSA9IHtcbiAgICAgIHNob3c6IGZhbHNlLFxuICAgICAgdG9wOiAwLFxuICAgICAgbGVmdDogMCxcbiAgICB9O1xuICB9XG5cbiAgdXBDb21wb25lbnQoKSB7XG4gICAgLy8g5LiK56e75Zu+5bGCIGluZGV477yM6KGo56S65YWD57Sg5Zyo5pWw57uE5Lit6LaK5b6A5ZCOXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50SW5kZXggPCB0aGlzLmNvbXBvbmVudERhdGEubGVuZ3RoIC0gMSkge1xuICAgICAgc3dhcChcbiAgICAgICAgdGhpcy5jb21wb25lbnREYXRhLFxuICAgICAgICB0aGlzLmN1ckNvbXBvbmVudEluZGV4LFxuICAgICAgICB0aGlzLmN1ckNvbXBvbmVudEluZGV4ICsgMVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tZXNzYWdlLndhcm5pbmcoJ+W3sue7j+WIsOmhtuS6hicpO1xuICAgIH1cbiAgfVxuXG4gIGRvd25Db21wb25lbnQoKSB7XG4gICAgLy8g5LiL56e75Zu+5bGCIGluZGV477yM6KGo56S65YWD57Sg5Zyo5pWw57uE5Lit6LaK5b6A5YmNXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50SW5kZXggPiAwKSB7XG4gICAgICBzd2FwKFxuICAgICAgICB0aGlzLmNvbXBvbmVudERhdGEsXG4gICAgICAgIHRoaXMuY3VyQ29tcG9uZW50SW5kZXgsXG4gICAgICAgIHRoaXMuY3VyQ29tcG9uZW50SW5kZXggLSAxXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1lc3NhZ2Uud2FybmluZygn5bey57uP5Yiw5bqV5LqGJyk7XG4gICAgfVxuICB9XG5cbiAgdG9wQ29tcG9uZW50KCkge1xuICAgIC8vIOe9rumhtlxuICAgIGlmICh0aGlzLmN1ckNvbXBvbmVudEluZGV4IDwgdGhpcy5jb21wb25lbnREYXRhLmxlbmd0aCAtIDEpIHtcbiAgICAgIHN3YXAoXG4gICAgICAgIHRoaXMuY29tcG9uZW50RGF0YSxcbiAgICAgICAgdGhpcy5jdXJDb21wb25lbnRJbmRleCxcbiAgICAgICAgdGhpcy5jb21wb25lbnREYXRhLmxlbmd0aCAtIDFcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWVzc2FnZS53YXJuaW5nKCflt7Lnu4/liLDpobbkuoYnKTtcbiAgICB9XG4gIH1cblxuICBib3R0b21Db21wb25lbnQoKSB7XG4gICAgLy8g572u5bqVXG4gICAgaWYgKHRoaXMuY3VyQ29tcG9uZW50SW5kZXggPiAwKSB7XG4gICAgICBzd2FwKHRoaXMuY29tcG9uZW50RGF0YSwgdGhpcy5jdXJDb21wb25lbnRJbmRleCwgMCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubWVzc2FnZS53YXJuaW5nKCflt7Lnu4/liLDlupXkuoYnKTtcbiAgICB9XG4gIH1cblxuICByZWNvcmRTbmFwc2hvdCgpIHtcbiAgICAvLyDmt7vliqDmlrDnmoTlv6vnhadcbiAgICB0aGlzLnNuYXBzaG90RGF0YVsrK3RoaXMuc25hcHNob3RJbmRleF0gPSBkZWVwQ29weSh0aGlzLmNvbXBvbmVudERhdGEpO1xuICAgIC8vIOWcqCB1bmRvIOi/h+eoi+S4re+8jOa3u+WKoOaWsOeahOW/q+eFp+aXtu+8jOimgeWwhuWug+WQjumdoueahOW/q+eFp+a4heeQhuaOiVxuICAgIGlmICh0aGlzLnNuYXBzaG90SW5kZXggPCB0aGlzLnNuYXBzaG90RGF0YS5sZW5ndGggLSAxKSB7XG4gICAgICB0aGlzLnNuYXBzaG90RGF0YSA9IHRoaXMuc25hcHNob3REYXRhLnNsaWNlKDAsIHRoaXMuc25hcHNob3RJbmRleCArIDEpO1xuICAgIH1cbiAgfVxuXG4gIHVuZG8oKSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RJbmRleCA+PSAwKSB7XG4gICAgICB0aGlzLnNuYXBzaG90SW5kZXgtLTtcbiAgICAgIHRoaXMuY29tcG9uZW50RGF0YSA9XG4gICAgICAgIGRlZXBDb3B5KHRoaXMuc25hcHNob3REYXRhW3RoaXMuc25hcHNob3RJbmRleF0pIHx8IFtdO1xuICAgIH1cbiAgfVxuXG4gIHJlZG8oKSB7XG4gICAgaWYgKHRoaXMuc25hcHNob3RJbmRleCA8IHRoaXMuc25hcHNob3REYXRhLmxlbmd0aCAtIDEpIHtcbiAgICAgIHRoaXMuc25hcHNob3RJbmRleCsrO1xuICAgICAgdGhpcy5jb21wb25lbnREYXRhID1cbiAgICAgICAgZGVlcENvcHkodGhpcy5zbmFwc2hvdERhdGFbdGhpcy5zbmFwc2hvdEluZGV4XSkgfHwgW107XG4gICAgfVxuICB9XG5cbiAgc2V0U2hhcGVQb3NTdHlsZSh7IGtleSwgdmFsdWUgfSkge1xuICAgIHRoaXMuY3VyQ29tcG9uZW50LnN0eWxlW2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIGNvcHkoKSB7XG4gICAgdGhpcy5jb3B5RGF0YSA9IHtcbiAgICAgIGRhdGE6IGRlZXBDb3B5KHRoaXMuY3VyQ29tcG9uZW50KSxcbiAgICAgIGluZGV4OiB0aGlzLmN1ckNvbXBvbmVudEluZGV4LFxuICAgIH07XG4gIH1cblxuICBwYXN0ZShpc01vdXNlKSB7XG4gICAgaWYgKCF0aGlzLmNvcHlEYXRhKSB7XG4gICAgICB0aGlzLm1lc3NhZ2Uud2FybmluZygn6K+36YCJ5oup57uE5Lu2Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YSA9IHRoaXMuY29weURhdGEuZGF0YTtcblxuICAgIGlmIChpc01vdXNlKSB7XG4gICAgICBkYXRhLnN0eWxlLnRvcCA9IHRoaXMuY29udGV4dG1lbnUudG9wO1xuICAgICAgZGF0YS5zdHlsZS5sZWZ0ID0gdGhpcy5jb250ZXh0bWVudS5sZWZ0O1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhLnN0eWxlLnRvcCArPSAxMDtcbiAgICAgIGRhdGEuc3R5bGUubGVmdCArPSAxMDtcbiAgICB9XG5cbiAgICBkYXRhLmlkID0gZ2VuZXJhdGVJRCgpO1xuICAgIHRoaXMuYWRkQ29tcG9uZW50KGRhdGEpO1xuICAgIHRoaXMucmVjb3JkU25hcHNob3QoKTtcbiAgICB0aGlzLmNvcHlEYXRhID0gbnVsbDtcbiAgfVxuXG4gIGFkZENvbXBvbmVudChjb21wb25lbnQ6IENvbXBvbmVudEJhc2VEYXRhLCBpbmRleD86IG51bWJlcikge1xuICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmNvbXBvbmVudERhdGEuc3BsaWNlKGluZGV4LCAwLCBjb21wb25lbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvbXBvbmVudERhdGEucHVzaChjb21wb25lbnQpO1xuICAgIH1cbiAgfVxuXG4gIGN1dCgpIHtcbiAgICBpZiAoIXRoaXMuY3VyQ29tcG9uZW50KSB7XG4gICAgICB0aGlzLm1lc3NhZ2Uud2FybmluZygn6K+36YCJ5oup57uE5Lu2Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29weURhdGEpIHtcbiAgICAgIHRoaXMuYWRkQ29tcG9uZW50KHRoaXMuY29weURhdGEuZGF0YSwgdGhpcy5jb3B5RGF0YS5pbmRleCk7XG4gICAgICBpZiAodGhpcy5jdXJDb21wb25lbnRJbmRleCA+PSB0aGlzLmNvcHlEYXRhLmluZGV4KSB7XG4gICAgICAgIC8vIOWmguaenOW9k+WJjee7hOS7tue0ouW8leWkp+S6juetieS6juaPkuWFpee0ouW8le+8jOmcgOimgeWKoOS4gO+8jOWboOS4uuW9k+WJjee7hOS7tuW+gOWQjuenu+S6huS4gOS9jVxuICAgICAgICB0aGlzLmN1ckNvbXBvbmVudEluZGV4Kys7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuY29weSgpO1xuICAgIHRoaXMuZGVsZXRlQ3VyQ29tcG9uZW50KCk7XG4gIH1cblxuICBjbGVhckNhbnZhcygpIHtcbiAgICB0aGlzLmNvbXBvbmVudERhdGEgPSBbXTtcbiAgfVxuXG4gIHJlc3RvcmUoZGF0YT86IFN0b3JhZ2VEYXRhKSB7XG4gICAgLy8g55So5L+d5a2Y55qE5pWw5o2u5oGi5aSN55S75biDXG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIHRoaXMuY29tcG9uZW50RGF0YSA9IHRoaXMucmVzZXRJRChkYXRhLmNhbnZhc0RhdGEpO1xuICAgICAgdGhpcy5jYW52YXNTdHlsZURhdGEgPSBkYXRhLmNhbnZhc1N0eWxlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NhbnZhc0RhdGEnKSkge1xuICAgICAgICB0aGlzLmNvbXBvbmVudERhdGEgPSB0aGlzLnJlc2V0SUQoXG4gICAgICAgICAgSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY2FudmFzRGF0YScpKVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NhbnZhc1N0eWxlJykpIHtcbiAgICAgICAgdGhpcy5jYW52YXNTdHlsZURhdGEgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdjYW52YXNTdHlsZScpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzYXZlKCkge1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdjYW52YXNEYXRhJywgSlNPTi5zdHJpbmdpZnkodGhpcy5jb21wb25lbnREYXRhKSk7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NhbnZhc1N0eWxlJywgSlNPTi5zdHJpbmdpZnkodGhpcy5jYW52YXNTdHlsZURhdGEpKTtcbiAgICB0aGlzLm1lc3NhZ2Uuc3VjY2Vzcygn5L+d5a2Y5oiQ5YqfJyk7XG4gICAgdGhpcy4kc3RvcmFnZURhdGEubmV4dCh7XG4gICAgICBjYW52YXNEYXRhOiB0aGlzLmNvbXBvbmVudERhdGEsXG4gICAgICBjYW52YXNTdHlsZTogdGhpcy5jYW52YXNTdHlsZURhdGEsXG4gICAgfSk7XG4gIH1cblxuICByZXNldElEKGRhdGEpIHtcbiAgICBkYXRhLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgIGl0ZW0uaWQgPSBnZW5lcmF0ZUlEKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIHNldEVkaXRNb2RlKHR5cGU6IEVkaXRNb2RlVHlwZSkge1xuICAgIHRoaXMuZWRpdE1vZGUgPSB0eXBlO1xuICB9XG59XG4iXX0=